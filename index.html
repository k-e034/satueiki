<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>わたくしの撮影記</title>
    <link rel="icon" href="images/icons/favicon.ico" sizes="32x32">
    <link rel="icon" href="images/icons/favicon.svg" type="image/svg">
    <link rel="shortcut icon" href="images/icons/favicon.svg" type="image/svg">
    <link rel="apple-touch-icon" href="images/icons/apple-touch-icon.png" sizes="180x180">
    <link rel="mask-icon" href="images/icons/safari-pinned-tab.svg" color="#3498db">
    <link rel="stylesheet" href="css/main.css">
</head>

<!-- モバイル対応版SVGフィルター定義 -->
<svg xmlns="http://www.w3.org/2000/svg" width="0" height="0">
    <defs>
        <!-- デスクトップ用の高品質フィルター -->
        <filter id="sticker-desktop">
            <!-- ノイズテクスチャ生成 - 粗さを微調整 -->
            <feTurbulence type="fractalNoise" baseFrequency="0.025" numOctaves="1" seed="14" stitchTiles="noStitch" result="noise"/>
            <feColorMatrix in="noise" type="saturate" values="25" result="saturatedNoise"/>
            <feMorphology in="SourceGraphic" operator="dilate" radius="4" result="dilated"/>
            <feFlood x="0" y="0" width="100%" height="100%" flood-color="#1a252f" flood-opacity="0.95" result="shadow"/>
            <feGaussianBlur in="SourceGraphic" stdDeviation="1.8" edgeMode="none" result="blurred"/>
            <feOffset in="saturatedNoise" dx="0" dy="0" result="offsetNoise"/>
            <feComposite in="shadow" in2="dilated" operator="in" result="shadowMask"/>
            <feDiffuseLighting in="blurred" surfaceScale="5" diffuseConstant="1.2" lighting-color="#4aa3df" result="lighting">
                <fePointLight id="light-desktop" x="150" y="60" z="20"/>
            </feDiffuseLighting>
            <feComposite in="offsetNoise" in2="SourceGraphic" operator="atop" result="noiseAtop"/>
            <feComposite in="noiseAtop" in2="shadowMask" operator="atop" result="compositedShadow"/>
            <feTurbulence type="fractalNoise" baseFrequency="3" numOctaves="1" seed="0" stitchTiles="noStitch" result="fineNoise"/>
            <feComposite in="lighting" in2="compositedShadow" operator="in" result="lightedShadow"/>
            <feBlend in="lightedShadow" in2="compositedShadow" mode="color-dodge" result="blended"/>
            <feColorMatrix in="fineNoise" type="matrix" values="1 0 0 0 0   0.95 1.05 0 0 0   0.9 0 1.1 0 0   0.03 0 0 0 0" result="coloredNoise"/>
            <feComposite in="coloredNoise" in2="blended" operator="atop"/>
        </filter>
        <!-- モバイル用の軽量フィルター -->
        <filter id="sticker-mobile">
            <feMorphology in="SourceGraphic" operator="dilate" radius="2" result="dilated"/>
            <feFlood x="0" y="0" width="100%" height="100%" flood-color="#1a252f" flood-opacity="0.9" result="shadow"/>
            <feComposite in="shadow" in2="dilated" operator="in" result="shadowMask"/>
            <feGaussianBlur in="SourceGraphic" stdDeviation="1" result="blurred"/>
            <feDiffuseLighting in="blurred" surfaceScale="3" diffuseConstant="1" lighting-color="#4aa3df" result="lighting">
                <fePointLight id="light-mobile" x="150" y="60" z="15"/>
            </feDiffuseLighting>
            <feComposite in="lighting" in2="shadowMask" operator="in" result="lightedShadow"/>
            <feBlend in="lightedShadow" in2="shadowMask" mode="color-dodge"/>
        </filter>
    </defs>
</svg>

<body>
    <!-- ヘッダー -->
    <header>
        <div class="header-container">
            <div class="logo"><a href="index.html">わたくしの撮影記</a></div>
            <nav><ul><li><a href="index.html">ホーム</a></li><li><a href="#tag-section">タグ検索</a></li></ul></nav>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <div class="main-content">
    <div id="photo-grid" class="roll-grid">
<section class="roll-section" data-tags="2025-03,saitama,snap,canon-ivsb2,canon-50mm,fuji-200">
  <h2 class="roll-title"><a href="rolls/roll_0018.html">Roll 0018</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2025年3月</span>
    <span class="roll-count">1枚</span>
  </div>
  <a href="rolls/roll_0018.html" class="roll-thumb-link">
    <img src="images/photos/0018_0005.JPG" alt="Roll 0018" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2025-02,miyazaki,animals,landscape,pentax-67,67-90mm,kodak-gold">
  <h2 class="roll-title"><a href="rolls/roll_0017.html">Roll 0017</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2025年2月</span>
    <span class="roll-count">1枚</span>
  </div>
  <a href="rolls/roll_0017.html" class="roll-thumb-link">
    <img src="images/photos/0017_0008_1.JPG" alt="Roll 0017" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2025-02,miyazaki,landscape,pentax-67,67-55mm,lomography-cn100">
  <h2 class="roll-title"><a href="rolls/roll_0016.html">Roll 0016</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2025年2月</span>
    <span class="roll-count">1枚</span>
  </div>
  <a href="rolls/roll_0016.html" class="roll-thumb-link">
    <img src="images/photos/0016_0008.jpg" alt="Roll 0016" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2024-12,tokyo,snap,mono,nikon-f70d,nikkor-28-200mm,ilford-xp2,animals,nikkor-50mm">
  <h2 class="roll-title"><a href="rolls/roll_0014.html">Roll 0014</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2024年12月</span>
    <span class="roll-count">3枚</span>
  </div>
  <a href="rolls/roll_0014.html" class="roll-thumb-link">
    <img src="images/photos/0014_0023.JPG" alt="Roll 0014" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2024-12,tokyo,snap,pentax-67,67-55mm,kodak-gold,landscape,67-55,2024-11">
  <h2 class="roll-title"><a href="rolls/roll_0013.html">Roll 0013</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2024年11月</span>
    <span class="roll-count">4枚</span>
  </div>
  <a href="rolls/roll_0013.html" class="roll-thumb-link">
    <img src="images/photos/0013_0005.jpg" alt="Roll 0013" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2024-11,tokyo,snap,landscape,canon-ivsb2,canon-35mm,kodak-colorplus">
  <h2 class="roll-title"><a href="rolls/roll_0012.html">Roll 0012</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2024年11月</span>
    <span class="roll-count">4枚</span>
  </div>
  <a href="rolls/roll_0012.html" class="roll-thumb-link">
    <img src="images/photos/0012_0023.JPG" alt="Roll 0012" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2024-09,tokyo,landscape,pentax-67,67-90mm,kodak-gold">
  <h2 class="roll-title"><a href="rolls/roll_0010.html">Roll 0010</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2024年9月</span>
    <span class="roll-count">1枚</span>
  </div>
  <a href="rolls/roll_0010.html" class="roll-thumb-link">
    <img src="images/photos/0010_0006_e.jpg" alt="Roll 0010" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2024-09,osaka,snap,olympus-om1,zuiko-50mm1,ilford-vintagetone,longexposure,night">
  <h2 class="roll-title"><a href="rolls/roll_0008.html">Roll 0008</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2024年9月</span>
    <span class="roll-count">3枚</span>
  </div>
  <a href="rolls/roll_0008.html" class="roll-thumb-link">
    <img src="images/photos/0008_0012.JPG" alt="Roll 0008" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2024-07,tokyo,snap,nikon-f70d,nikkor-50mm,fuji-super">
  <h2 class="roll-title"><a href="rolls/roll_0006.html">Roll 0006</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2024年7月</span>
    <span class="roll-count">1枚</span>
  </div>
  <a href="rolls/roll_0006.html" class="roll-thumb-link">
    <img src="images/photos/0006_0043.JPG" alt="Roll 0006" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2024-07,tokyo,snap,animals,canon-ftbn,fd-50mm,kodak-colorplus,kanagawa,landscape,fd-80-200mm">
  <h2 class="roll-title"><a href="rolls/roll_0005.html">Roll 0005</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2024年7月</span>
    <span class="roll-count">2枚</span>
  </div>
  <a href="rolls/roll_0005.html" class="roll-thumb-link">
    <img src="images/photos/0005_0025.JPG" alt="Roll 0005" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2024-06,tokyo,mono,snap,nikon-f70d,nikkor-50mm,ilford-xp2,nikkor-80-200mm">
  <h2 class="roll-title"><a href="rolls/roll_0003.html">Roll 0003</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2024年6月</span>
    <span class="roll-count">2枚</span>
  </div>
  <a href="rolls/roll_0003.html" class="roll-thumb-link">
    <img src="images/photos/0003_0033.JPG" alt="Roll 0003" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2024-04,miyagi,landscape,nikon-f70d,nikkor-28-80mm,kodak-ultramax,snap,nikkor-28-80">
  <h2 class="roll-title"><a href="rolls/roll_0002.html">Roll 0002</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2024年4月</span>
    <span class="roll-count">3枚</span>
  </div>
  <a href="rolls/roll_0002.html" class="roll-thumb-link">
    <img src="images/photos/0002_0005.JPG" alt="Roll 0002" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2024-04,akita,snap,nikon-f70d,nikkor-28-80,kodak-ultramax,landscape">
  <h2 class="roll-title"><a href="rolls/roll_0001.html">Roll 0001</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2024年4月</span>
    <span class="roll-count">2枚</span>
  </div>
  <a href="rolls/roll_0001.html" class="roll-thumb-link">
    <img src="images/photos/0001_0030.JPG" alt="Roll 0001" class="roll-thumb" loading="lazy">
  </a>
</section>
<section class="roll-section" data-tags="2025-01,tokyo,snap,nikon-d800,nikkor-50mm,2024-08,saitama,fuji-s5pro">
  <h2 class="roll-title"><a href="rolls/roll_D.html">Digital Photos</a></h2>
  <div class="roll-meta">
    <span class="roll-period">2024年8月</span>
    <span class="roll-count">2枚</span>
  </div>
  <a href="rolls/roll_D.html" class="roll-thumb-link">
    <img src="images/photos/D_6554.jpg" alt="Digital Photos" class="roll-thumb" loading="lazy">
  </a>
</section>
    </div>
    <div class="load-more-container" style="display: none;">
      <button id="load-more" class="btn">もっと見る</button>
    </div>
    
    
    
    
        
    </div>

    <!-- タグ検索セクションの直前に選択中タグ表示エリアを追加 -->
    <div id="selected-tags" class="selected-tags"></div>

    <!-- タグ検索セクション -->
    <section id="tag-section" class="tag-section">
        <h2 class="section-title">タグで探す</h2>
        <div class="tag-container">
<div class="tag-category">
  <h3>撮影時期</h3>
  <div class="tags">
<a href="#" class="tag" data-tag="2025-03">2025年3月</a>
<a href="#" class="tag" data-tag="2025-02">2025年2月</a>
<a href="#" class="tag" data-tag="2025-01">2025年1月</a>
<a href="#" class="tag" data-tag="2024-12">2024年12月</a>
<a href="#" class="tag" data-tag="2024-11">2024年11月</a>
<a href="#" class="tag" data-tag="2024-09">2024年9月</a>
<a href="#" class="tag" data-tag="2024-08">2024年8月</a>
<a href="#" class="tag" data-tag="2024-07">2024年7月</a>
<a href="#" class="tag" data-tag="2024-06">2024年6月</a>
<a href="#" class="tag" data-tag="2024-04">2024年4月</a>
  </div>
</div>
<div class="tag-category">
  <h3>撮影場所</h3>
  <div class="tags">
<a href="#" class="tag" data-tag="miyagi">宮城県</a>
<a href="#" class="tag" data-tag="saitama">埼玉県</a>
<a href="#" class="tag" data-tag="tokyo">東京都</a>
<a href="#" class="tag" data-tag="kanagawa">神奈川県</a>
<a href="#" class="tag" data-tag="osaka">大阪府</a>
<a href="#" class="tag" data-tag="miyazaki">宮崎県</a>
  </div>
</div>
<div class="tag-category">
  <h3>カメラ</h3>
  <div class="tags">
<a href="#" class="tag" data-tag="canon-ivsb2">Canon IV Sb2</a>
<a href="#" class="tag" data-tag="canon-ftbn">Canon FTb-N</a>
<a href="#" class="tag" data-tag="fuji-s5pro">Fujifilm FinePix S5 Pro</a>
<a href="#" class="tag" data-tag="nikon-f70d">Nikon F70D</a>
<a href="#" class="tag" data-tag="nikon-d800">Nikon D800</a>
<a href="#" class="tag" data-tag="olympus-om1">Olympus OM-1</a>
<a href="#" class="tag" data-tag="pentax-67">Pentax 6×7</a>
  </div>
</div>
<div class="tag-category">
  <h3>レンズ</h3>
  <div class="tags">
<a href="#" class="tag" data-tag="canon-35mm">Canon Serenar 35mm F3.5</a>
<a href="#" class="tag" data-tag="canon-50mm">Canon Lens 50mm F1.8</a>
<a href="#" class="tag" data-tag="fd-50mm">Canon FD 50mm F1.4 S.S.C.</a>
<a href="#" class="tag" data-tag="fd-80-200mm">Canon NewFD 80-200mm F4</a>
<a href="#" class="tag" data-tag="zuiko-50mm1">Olympus G.Zuiko 50mm F1.4</a>
<a href="#" class="tag" data-tag="67-55mm">Pentax SMC TAKUMAR 6×7/55mm F3.5</a>
<a href="#" class="tag" data-tag="67-90mm">Pentax SMC TAKUMAR 6×7/90mm F2.8</a>
<a href="#" class="tag" data-tag="nikkor-28-80mm">AI AF Zoom-Nikkor 28-80mm F3.5-5.6 D</a>
<a href="#" class="tag" data-tag="nikkor-28-200mm">AI AF-S Zoom-Nikkor 28-200mm F3.5-5.6 D</a>
<a href="#" class="tag" data-tag="nikkor-80-200mm">AI AF-S Zoom-Nikkor 80-200mm F2.8 ED</a>
<a href="#" class="tag" data-tag="nikkor-50mm">AI AF Nikkor 50mm F1.4</a>
  </div>
</div>
<div class="tag-category">
  <h3>フィルム</h3>
  <div class="tags">
<a href="#" class="tag" data-tag="kodak-colorplus">Kodak ColorPlus 200</a>
<a href="#" class="tag" data-tag="kodak-gold">Kodak Gold 200</a>
<a href="#" class="tag" data-tag="kodak-ultramax">Kodak UltraMax 400</a>
<a href="#" class="tag" data-tag="fuji-200">FUJIFILM 200</a>
<a href="#" class="tag" data-tag="fuji-super">FUJIFILM SUPER 400</a>
<a href="#" class="tag" data-tag="ilford-xp2">ILFORD XP2 Super 400</a>
<a href="#" class="tag" data-tag="ilford-vintagetone">ILFORD ILFOCOLOR 400 PLUS Vintage Tone</a>
<a href="#" class="tag" data-tag="lomography-cn100">Lomography Color Negative 100</a>
  </div>
</div>
<div class="tag-category">
  <h3>写真のスタイル</h3>
  <div class="tags">
<a href="#" class="tag" data-tag="mono">モノクロ</a>
<a href="#" class="tag" data-tag="landscape">風景</a>
<a href="#" class="tag" data-tag="snap">スナップショット</a>
<a href="#" class="tag" data-tag="longexposure">長時間露光</a>
<a href="#" class="tag" data-tag="night">夜景</a>
<a href="#" class="tag" data-tag="animals">動物</a>
  </div>
</div>
        </div>
    </section>

    <!-- トップに戻るボタン (モバイル用) -->
    <button class="nav-btn" id="gallery-btn" title="トップに戻る">↑</button>

    <!-- フッター -->
    <footer>
        <div class="footer-container">
            <div class="footer-section"><h3>わたくしの撮影記</h3><p>個人的な写真撮影の記録のブログです。</p></div>
            <div class="footer-section"><h3>リンク</h3><ul><li><a href="index.html">ホーム</a></li></ul></div>
            <div class="footer-section"><h3>フォロー</h3><p>SNSで最新の写真や撮影の裏側をチェックしてください。</p><div class="social-icons"><a href="#">I</a><a href="#">T</a><a href="#">F</a><a href="#">P</a></div></div>
        </div>
        <div class="copyright">&copy; 2025 k.e. All Rights Reserved.</div>
    </footer>
    <script src="js/common.js"></script>
    <script src="js/photoLoader.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const galleryBtn = document.getElementById('gallery-btn');
            if (galleryBtn) {
                window.addEventListener('scroll', function() {
                    if (window.scrollY > 300) galleryBtn.classList.add('visible'); else galleryBtn.classList.remove('visible');
                });
                galleryBtn.addEventListener('click', function() {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
        });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
      // iOSかどうか判定
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  
      if (isIOS) {
        // ロゴ要素を取得
        const logoLink = document.querySelector('.logo a');
    
        // フィルターを取り除き、代替スタイルを適用
        if (logoLink) {
          logoLink.style.filter = 'none';
          logoLink.style.textShadow = '0 2px 4px rgba(0,0,0,0.4), 0 0 8px rgba(52, 152, 219, 0.6)';
          // 必要に応じて他のスタイルを追加
        }
      }
    });
    </script>
    <!-- タグ選択・表示用のJavaScriptを修正版 -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        class TagManager {
            constructor() {
                this.selectedTags = new Set();
                this.tagDisplayNames = {
                    '2025-03': '2025年3月', '2025-02': '2025年2月', '2025-01': '2025年1月',
                    '2024-12': '2024年12月', '2024-11': '2024年11月', '2024-09': '2024年9月',
                    '2024-08': '2024年8月', '2024-07': '2024年7月', '2024-06': '2024年6月',
                    '2024-04': '2024年4月', 'miyagi': '宮城県', 'saitama': '埼玉県',
                    'tokyo': '東京都', 'kanagawa': '神奈川県', 'osaka': '大阪府',
                    'miyazaki': '宮崎県', 'akita': '秋田県', 'canon-ivsb2': 'Canon IV Sb2',
                    'canon-ftbn': 'Canon FTb-N', 'fuji-s5pro': 'Fujifilm FinePix S5 Pro',
                    'nikon-f70d': 'Nikon F70D', 'nikon-d800': 'Nikon D800',
                    'olympus-om1': 'Olympus OM-1', 'pentax-67': 'Pentax 6×7',
                    'canon-35mm': 'Canon Serenar 35mm F3.5', 'canon-50mm': 'Canon Lens 50mm F1.8',
                    'fd-50mm': 'Canon FD 50mm F1.4 S.S.C.', 'fd-80-200mm': 'Canon NewFD 80-200mm F4',
                    'zuiko-50mm1': 'Olympus G.Zuiko 50mm F1.4', '67-55mm': 'Pentax SMC TAKUMAR 6×7/55mm F3.5',
                    '67-90mm': 'Pentax SMC TAKUMAR 6×7/90mm F2.8', 'nikkor-28-80mm': 'AI AF Zoom-Nikkor 28-80mm F3.5-5.6 D',
                    'nikkor-28-200mm': 'AI AF-S Zoom-Nikkor 28-200mm F3.5-5.6 D',
                    'nikkor-80-200mm': 'AI AF-S Zoom-Nikkor 80-200mm F2.8 ED',
                    'nikkor-50mm': 'AI AF Nikkor 50mm F1.4', 'nikkor-28-80': 'AI AF Zoom-Nikkor 28-80mm F3.5-5.6 D',
                    '67-55': 'Pentax SMC TAKUMAR 6×7/55mm F3.5',
                    'kodak-colorplus': 'Kodak ColorPlus 200', 'kodak-gold': 'Kodak Gold 200', 
                    'kodak-ultramax': 'Kodak UltraMax 400', 'fuji-200': 'FUJIFILM 200', 
                    'fuji-super': 'FUJIFILM SUPER 400', 'ilford-xp2': 'ILFORD XP2 Super 400', 
                    'ilford-vintagetone': 'ILFORD ILFOCOLOR 400 PLUS Vintage Tone',
                    'lomography-cn100': 'Lomography Color Negative 100',
                    'mono': 'モノクロ', 'landscape': '風景', 'snap': 'スナップショット',
                    'longexposure': '長時間露光', 'night': '夜景', 'animals': '動物'
                };
                this.init();
            }
            
            init() {
                this.loadFromURL();
                this.setupEventListeners();
                this.updateUI();
            }
            
            loadFromURL() {
                const params = new URLSearchParams(window.location.search);
                const tagParam = params.get('tag');
                if (tagParam) {
                    tagParam.split(',').forEach(tag => {
                        if (tag.trim()) this.selectedTags.add(tag.trim());
                    });
                }
            }
            
            setupEventListeners() {
                // タグクリックイベント
                document.querySelectorAll('.tag[data-tag]').forEach(tagLink => {
                    tagLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tag = tagLink.getAttribute('data-tag');
                        this.toggleTag(tag);
                    });
                });
            }
            
            // スクロール位置を保持してタグを切り替える
            toggleTag(tag) {
                // 現在のスクロール位置を記録（より正確な値を取得）
                const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;
                
                // スクロール復元のための参照点を設定
                const scrollAnchor = this.createScrollAnchor();
                
                if (this.selectedTags.has(tag)) {
                    this.selectedTags.delete(tag);
                } else {
                    this.selectedTags.add(tag);
                }
                
                // DOM操作を非同期で実行してスクロール位置を維持
                this.performUpdate(scrollAnchor, currentScrollY);
            }
            
            // スクロール位置復元用のアンカーを作成
            createScrollAnchor() {
                const scrollY = window.pageYOffset || document.documentElement.scrollTop;
                const viewportHeight = window.innerHeight;
                
                // 画面中央付近の要素を基準点として使用
                const targetY = scrollY + viewportHeight / 2;
                const elements = document.elementsFromPoint(window.innerWidth / 2, viewportHeight / 2);
                
                // 適切な基準要素を選択
                const anchorElement = elements.find(el => 
                    el.classList.contains('roll-section') || 
                    el.classList.contains('tag-section') ||
                    el.tagName === 'SECTION' ||
                    el.tagName === 'DIV'
                ) || document.body;
                
                return {
                    element: anchorElement,
                    offsetTop: anchorElement.offsetTop,
                    currentScrollY: scrollY
                };
            }
            
            // DOM更新とスクロール位置復元を実行
            performUpdate(scrollAnchor, originalScrollY) {
                // DOM更新前の状態を保存
                const beforeHeight = document.documentElement.scrollHeight;
                
                // UI更新を実行
                this.updateUI();
                this.updateURL();
                
                // DOM更新をフレーム単位で分離
                requestAnimationFrame(() => {
                    this.filterContent(() => {
                        // DOM更新完了後にスクロール位置を復元
                        requestAnimationFrame(() => {
                            this.restoreScrollPosition(scrollAnchor, originalScrollY, beforeHeight);
                        });
                    });
                });
            }
            
            // スクロール位置を正確に復元
            restoreScrollPosition(scrollAnchor, originalScrollY, beforeHeight) {
                try {
                    const afterHeight = document.documentElement.scrollHeight;
                    const heightDifference = afterHeight - beforeHeight;
                    
                    // 複数の復元方法を試行
                    let targetScrollY = originalScrollY;
                    
                    // 方法1: アンカー要素ベースの復元
                    if (scrollAnchor.element && scrollAnchor.element.offsetParent) {
                        const newOffsetTop = scrollAnchor.element.offsetTop;
                        const offsetDifference = newOffsetTop - scrollAnchor.offsetTop;
                        targetScrollY = Math.max(0, originalScrollY + offsetDifference);
                    }
                    // 方法2: 高さ変化ベースの復元（フォールバック）
                    else if (Math.abs(heightDifference) < window.innerHeight) {
                        targetScrollY = Math.max(0, originalScrollY + heightDifference * 0.5);
                    }
                    
                    // スムーズでない即座の移動
                    window.scrollTo(0, targetScrollY);
                    
                    // 微調整のための再チェック
                    setTimeout(() => {
                        const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
                        const maxScroll = document.documentElement.scrollHeight - window.innerHeight;
                        
                        if (Math.abs(currentScroll - targetScrollY) > 10 && targetScrollY <= maxScroll) {
                            window.scrollTo(0, Math.min(targetScrollY, maxScroll));
                        }
                    }, 50);
                    
                } catch (error) {
                    // エラー時は元の位置に戻す
                    console.warn('スクロール位置の復元に失敗:', error);
                    window.scrollTo(0, Math.max(0, originalScrollY));
                }
            }
            
            updateUI() {
                // タグの選択状態を更新
                document.querySelectorAll('.tag[data-tag]').forEach(tagElement => {
                    const tag = tagElement.getAttribute('data-tag');
                    tagElement.classList.toggle('selected', this.selectedTags.has(tag));
                });
                
                // 選択中タグの表示を更新
                this.updateSelectedTagsDisplay();
            }
            
            updateSelectedTagsDisplay() {
                const container = document.getElementById('selected-tags');
                if (!container) return;
                
                // 高さの変化を最小限に抑える
                if (this.selectedTags.size === 0) {
                    // 空の状態でも最小高さを維持
                    container.style.display = 'block';
                    container.style.minHeight = '60px';
                    container.innerHTML = '<div style="padding: 1rem; color: #666; text-align: center;">タグを選択してロールを絞り込み</div>';
                } else {
                    container.style.display = 'block';
                    container.style.minHeight = '60px';
                    container.innerHTML = '';
                    
                    this.selectedTags.forEach(tag => {
                        const tagElement = document.createElement('span');
                        tagElement.className = 'selected-tag';
                        tagElement.textContent = this.tagDisplayNames[tag] || tag;
                        tagElement.title = 'クリックで解除';
                        tagElement.onclick = (e) => {
                            e.stopPropagation();
                            this.toggleTag(tag);
                        };
                        container.appendChild(tagElement);
                    });
                }
            }
            
            updateURL() {
                const url = new URL(window.location);
                if (this.selectedTags.size > 0) {
                    url.searchParams.set('tag', Array.from(this.selectedTags).join(','));
                } else {
                    url.searchParams.delete('tag');
                }
                // replaceStateでブラウザ履歴に影響しないよう更新
                window.history.replaceState({}, '', url);
            }
            
            filterContent(callback) {
                const rollSections = document.querySelectorAll('.roll-section');
                
                if (this.selectedTags.size === 0) {
                    // 全て表示状態に戻す
                    rollSections.forEach(section => {
                        section.style.display = '';
                        section.style.opacity = '1';
                    });
                    this.showMessage('');
                } else {
                    // フィルタリング実行
                    let visibleCount = 0;
                    
                    rollSections.forEach(section => {
                        const sectionTags = section.getAttribute('data-tags');
                        const shouldShow = sectionTags && 
                            Array.from(this.selectedTags).some(tag => 
                                sectionTags.split(',').includes(tag)
                            );
                        
                        if (shouldShow) {
                            section.style.display = '';
                            section.style.opacity = '1';
                            visibleCount++;
                        } else {
                            section.style.display = 'none';
                        }
                    });
                    
                    this.showMessage(visibleCount === 0 ? 
                        '選択されたタグに一致するロールはありません。' : 
                        `${visibleCount}個のロールが表示されています。`
                    );
                }
                
                // コールバック実行
                if (callback) {
                    setTimeout(callback, 10);
                }
            }
            
            showMessage(message) {
                let messageEl = document.getElementById('filter-message');
                if (!messageEl) {
                    messageEl = document.createElement('div');
                    messageEl.id = 'filter-message';
                    messageEl.style.cssText = `
                        text-align: center;
                        margin: 1rem 0;
                        padding: 1rem;
                        background-color: rgba(255,255,255,0.05);
                        border-radius: 8px;
                        color: #aaa;
                        min-height: 2rem;
                        transition: opacity 0.2s ease;
                        box-sizing: border-box;
                    `;
                    
                    // selected-tagsの直後に挿入
                    const selectedTags = document.getElementById('selected-tags');
                    if (selectedTags && selectedTags.parentNode) {
                        selectedTags.parentNode.insertBefore(messageEl, selectedTags.nextSibling);
                    } else {
                        document.getElementById('photo-grid').parentNode.insertBefore(
                            messageEl, 
                            document.getElementById('photo-grid')
                        );
                    }
                }
                
                if (message) {
                    messageEl.textContent = message;
                    messageEl.style.display = 'block';
                    messageEl.style.opacity = '1';
                } else {
                    messageEl.style.opacity = '0';
                    setTimeout(() => {
                        messageEl.textContent = '';
                        messageEl.style.display = 'block'; // 高さを維持
                    }, 200);
                }
            }
        }
        
        // 初期化
        window.tagManager = new TagManager();
        
        // CSS追加（レイアウトシフト防止強化版）
        const style = document.createElement('style');
        style.textContent = `
            /* スムーズスクロールを無効化 */
            html {
                scroll-behavior: auto !important;
            }
            
            #selected-tags {
                margin-bottom: 1rem;
                padding: 1rem;
                background-color: rgba(52, 152, 219, 0.1);
                border-radius: 8px;
                border: 1px solid rgba(52, 152, 219, 0.3);
                display: block;
                min-height: 60px;
                box-sizing: border-box;
                transition: none; /* アニメーションを無効化 */
            }
            
            .selected-tag {
                display: inline-block;
                background: #3498db;
                color: #fff;
                border-radius: 15px;
                padding: 0.4em 0.8em;
                margin: 0.2em 0.5em 0.2em 0;
                cursor: pointer;
                font-size: 0.9em;
                transition: background-color 0.1s ease; /* 短縮 */
                position: relative;
            }
            
            .selected-tag:hover {
                background: #2980b9;
                transform: translateY(-1px);
            }
            
            .selected-tag::after {
                content: " ×";
                font-weight: bold;
            }
            
            .tag.selected {
                background-color: #3498db !important;
                color: white !important;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
            }
            
            .roll-section {
                transition: opacity 0.1s ease; /* 短縮 */
            }
            
            .roll-section:hover {
                transform: translateY(-5px);
            }
            
            /* メッセージ要素の固定高さ */
            #filter-message {
                box-sizing: border-box;
                min-height: 2rem;
            }
            
            /* レイアウトシフト防止のための安定化 */
            .main-content {
                min-height: 100vh;
            }
            
            .roll-grid {
                min-height: 400px; /* 最小高さを設定 */
            }
        `;
        document.head.appendChild(style);
    });
    </script>
</body>
</html>